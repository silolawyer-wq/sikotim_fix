<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>SILO KOORDINASI TIM (SIKOTIM) - Sui Iuris Law Office</title>

    <link
      rel="icon"
      type="image/png"
      href="https://img.icons8.com/fluency-systems-filled/96/C5A059/scales.png"
    />

    <!-- Google Fonts: Elite Professionalism -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,500;0,700;1,600&family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              legal: {
                navy: "#0F172A",
                gold: "#C5A059",
                cream: "#FCFBF9",
                slate: "#64748B",
                border: "#E2E8F0",
              },
              royal: {
                deep: "#EEF2FF",
                600: "#4F46E5",
                700: "#4338CA",
              },
            },
            fontFamily: {
              serif: ["Cormorant Garamond", "serif"],
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>

    <style>
      :root {
        --primary: #0f172a;
        --accent: #c5a059;
        --surface: #ffffff;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc;
        color: #1e293b;
        -webkit-font-smoothing: antialiased;
        overflow-x: hidden;
      }

      .bg-matrix {
        background-image: radial-gradient(
            circle at 10% 20%,
            rgba(197, 160, 89, 0.08) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(15, 23, 42, 0.05) 0%,
            transparent 40%
          );
        background-attachment: fixed;
      }

      .font-serif-legal {
        font-family: "Cormorant Garamond", serif;
      }

      .card-premium {
        background: var(--surface);
        border: 1px solid rgba(15, 23, 42, 0.1);
        border-radius: 32px;
        transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
      }
      .card-premium:hover {
        transform: translateY(-8px);
        box-shadow: 0 40px 80px -20px rgba(15, 23, 42, 0.15);
        border-color: var(--accent);
      }

      .btn-action {
        background: var(--primary);
        color: white;
        border-radius: 18px;
        font-weight: 700;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        padding: 14px 28px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 10px 20px -5px rgba(15, 23, 42, 0.2);
      }
      .btn-action:hover {
        background: #000;
        transform: scale(1.02);
      }

      .header-glass {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(25px);
        border-bottom: 1px solid rgba(15, 23, 42, 0.05);
      }

      .input-premium {
        width: 100%;
        padding: 16px 24px;
        border: 2px solid #f1f5f9;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        transition: 0.3s;
        background: #f8fafc;
        outline: none;
      }
      .input-premium:focus {
        border-color: var(--accent);
        background: white;
        box-shadow: 0 0 0 5px rgba(197, 160, 89, 0.1);
      }

      .tab-btn {
        padding: 12px 24px;
        border-radius: 16px;
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        transition: 0.3s;
        color: #94a3b8;
        cursor: pointer;
      }
      .tab-active {
        background: var(--primary);
        color: white;
        box-shadow: 0 8px 20px -5px rgba(15, 23, 42, 0.3);
      }

      .timeline-spine {
        position: absolute;
        left: 40px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(
          to bottom,
          transparent,
          #e2e8f0,
          transparent
        );
      }

      .badge-type {
        padding: 5px 12px;
        border-radius: 10px;
        font-size: 9px;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: 1px solid;
      }

      .prio-high {
        background-color: #fee2e2;
        color: #b91c1c;
        border-color: #fecaca;
      }
      .prio-medium {
        background-color: #fef3c7;
        color: #92400e;
        border-color: #fde68a;
      }
      .prio-normal {
        background-color: #f1f5f9;
        color: #475569;
        border-color: #e2e8f0;
      }

      .editor-container {
        border-radius: 20px;
        border: 2px solid #f1f5f9;
        overflow: hidden;
        background: white;
        transition: 0.3s;
      }
      .editor-box {
        min-height: 150px;
        padding: 20px;
        outline: none;
        line-height: 1.7;
        color: #334155;
        font-size: 14px;
        text-align: left;
      }

      .nav-dock {
        display: flex;
        background: #f1f5f9;
        padding: 5px;
        border-radius: 20px;
        gap: 4px;
      }
      .nav-dock-item {
        padding: 10px 24px;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: 0.3s;
        color: #64748b;
      }
      .nav-dock-active {
        background: white;
        color: var(--primary);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .fade-in {
        animation: fadeIn 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .progress-image-preview {
        width: 100%;
        max-height: 300px;
        object-fit: cover;
        border-radius: 20px;
        border: 4px solid white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body class="bg-matrix text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef, Fragment } = React;

      // --- INITIALIZATION ---
      const firebaseConfig = {
        apiKey: "AIzaSyAEphurPmuFD5kZhFJ4QVJQICE4ZiQC_ew",
        authDomain: "silo-strategy-perkara.firebaseapp.com",
        projectId: "silo-strategy-perkara",
        storageBucket: "silo-strategy-perkara.firebasestorage.app",
        messagingSenderId: "407767849673",
        appId: "1:407767849673:web:cde798ede0eb2f1981537",
      };

      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();
      const storage = firebase.storage();
      const appId = "silo-sikotim-v1";

      // --- HELPERS ---
      const formatDate = (timestamp) => {
        if (!timestamp) return "-";
        if (timestamp.toDate) return timestamp.toDate().toLocaleString("id-ID");
        if (timestamp instanceof Date) return timestamp.toLocaleString("id-ID");
        return new Date(timestamp).toLocaleString("id-ID");
      };

      const getThemeByClassification = (type) => {
        const low = type?.toLowerCase();
        if (low === "pidana")
          return {
            border: "border-l-red-500",
            badge: "bg-red-50 text-red-700 border-red-200",
            icon: "Shield",
          };
        if (low === "perdata")
          return {
            border: "border-l-blue-500",
            badge: "bg-blue-50 text-blue-700 border-blue-200",
            icon: "FileText",
          };
        if (low === "tun")
          return {
            border: "border-l-purple-500",
            badge: "bg-purple-50 text-purple-700 border-purple-200",
            icon: "Layers",
          };
        if (low === "niaga")
          return {
            border: "border-l-emerald-500",
            badge: "bg-emerald-50 text-emerald-700 border-emerald-200",
            icon: "RefreshCw",
          };
        return {
          border: "border-l-slate-400",
          badge: "bg-slate-50 text-slate-700 border-slate-200",
          icon: "FileText",
        };
      };

      const Icon = ({ name, size = 18, className = "" }) => {
        const icons = {
          Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
          Logout: (
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />
          ),
          Plus: <path d="M12 5v14M5 12h14" />,
          X: (
            <Fragment>
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </Fragment>
          ),
          FileText: (
            <Fragment>
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
              <polyline points="14 2 14 8 20 8" />
            </Fragment>
          ),
          Search: (
            <Fragment>
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </Fragment>
          ),
          Maximize: (
            <Fragment>
              <path d="M8 3H5a2 2 0 0 0-2 2v3" />
              <path d="M21 8V5a2 2 0 0 0-2-2h-3" />
              <path d="M3 16v3a2 2 0 0 0 2 2h3" />
              <path d="M16 21h3a2 2 0 0 0 2-2v-3" />
            </Fragment>
          ),
          Minimize: (
            <Fragment>
              <path d="M8 3v3a2 2 0 0 1-2 2H3" />
              <path d="M21 8h-3a2 2 0 0 1-2-2V3" />
              <path d="M3 16h3a2 2 0 0 1 2 2v3" />
              <path d="M16 21v-3a2 2 0 0 1 2-2h3" />
            </Fragment>
          ),
          Trash: (
            <Fragment>
              <polyline points="3 6 5 6 21 6" />
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
            </Fragment>
          ),
          Download: (
            <Fragment>
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </Fragment>
          ),
          PenTool: (
            <Fragment>
              <path d="M12 19l7-7 3 3-7 7-3-3z" />
              <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z" />
              <path d="M2 2l5 5" />
            </Fragment>
          ),
          CheckCircle: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />,
          Star: (
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
          ),
          Layers: (
            <Fragment>
              <polygon points="12 2 2 7 12 12 22 7 12 2" />
              <polyline points="2 17 12 22 22 17" />
              <polyline points="2 12 12 17 22 12" />
            </Fragment>
          ),
          RefreshCw: (
            <Fragment>
              <polyline points="23 4 23 10 17 10" />
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
            </Fragment>
          ),
          Hammer: (
            <Fragment>
              <path d="M18.42 13.52L21.06 10.89C21.45 10.5 21.67 9.97 21.67 9.42C21.67 8.87 21.45 8.34 21.06 7.95L16.05 2.94C15.66 2.55 15.13 2.33 14.58 2.33C14.03 2.33 13.5 2.55 13.11 2.94L10.48 5.58L18.42 13.52Z" />
              <path d="M10.48 5.58L2.33 13.73V21.67H10.27L18.42 13.52" />
            </Fragment>
          ),
          Briefcase: (
            <Fragment>
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
            </Fragment>
          ),
          Folder: (
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
          ),
          Upload: (
            <Fragment>
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </Fragment>
          ),
          Camera: (
            <Fragment>
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
              <circle cx="12" cy="13" r="4" />
            </Fragment>
          ),
          MapPin: (
            <Fragment>
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
              <circle cx="12" cy="10" r="3" />
            </Fragment>
          ),
          Edit: (
            <Fragment>
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7" />
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
            </Fragment>
          ),
          Eye: (
            <Fragment>
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
              <circle cx="12" cy="12" r="3" />
            </Fragment>
          ),
          EyeOff: (
            <Fragment>
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" />
              <line x1="1" y1="1" x2="23" y2="23" />
            </Fragment>
          ),
          History: (
            <Fragment>
              <path d="M12 8v4l3 3" />
              <circle cx="12" cy="12" r="9" />
            </Fragment>
          ),
          MessageSquare: (
            <Fragment>
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
            </Fragment>
          ),
          AlertCircle: (
            <Fragment>
              <circle cx="12" cy="12" r="10" />
              <line x1="12" y1="8" x2="12" y2="12" />
              <line x1="12" y1="16" x2="12.01" y2="16" />
            </Fragment>
          ),
          Target: (
            <Fragment>
              <circle cx="12" cy="12" r="10" />
              <circle cx="12" cy="12" r="6" />
              <circle cx="12" cy="12" r="2" />
            </Fragment>
          ),
        };
        return (
          <svg
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2.5"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={className}
          >
            {icons[name] || null}
          </svg>
        );
      };

      // --- RICH TEXT EDITOR ---
      function RichEditor({ value, onChange, height = "150px" }) {
        const editorRef = useRef(null);
        const contentRef = useRef(value);

        useEffect(() => {
          if (editorRef.current && value !== contentRef.current) {
            editorRef.current.innerHTML = value || "";
            contentRef.current = value || "";
          }
        }, [value]);

        const handleInput = (e) => {
          const html = e.currentTarget.innerHTML;
          contentRef.current = html;
          onChange(html);
        };

        return (
          <div className="editor-container shadow-sm">
            <div
              ref={editorRef}
              contentEditable
              onInput={handleInput}
              className="editor-box"
              style={{ minHeight: height }}
              suppressContentEditableWarning={true}
            ></div>
          </div>
        );
      }

      // --- AUTH PAGE ---
      function AuthPage() {
        const [isReg, setIsReg] = useState(false);
        const [showPass, setShowPass] = useState(false);
        const [form, setForm] = useState({
          email: "",
          pass: "",
          name: "",
          role: "litigasi",
        });
        const [loading, setLoading] = useState(false);

        const handleAuth = async (e) => {
          e.preventDefault();
          setLoading(true);
          try {
            if (isReg) {
              const res = await auth.createUserWithEmailAndPassword(
                form.email,
                form.pass
              );
              await db
                .collection("artifacts")
                .doc(appId)
                .collection("public")
                .doc("data")
                .collection("users")
                .doc(res.user.uid)
                .set({
                  name: form.name,
                  role: form.role,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
              await auth.signOut();
              setIsReg(false);
              alert("Akun tim berhasil dibuat. Silakan login.");
            } else {
              await auth.signInWithEmailAndPassword(form.email, form.pass);
            }
          } catch (err) {
            alert(err.message);
          }
          setLoading(false);
        };

        return (
          <div className="min-h-screen bg-legal-navy flex items-center justify-center p-6 relative overflow-hidden bg-matrix">
            <div className="bg-white w-full max-w-md p-10 md:p-14 rounded-[3.5rem] shadow-2xl border-t-[12px] border-legal-gold fade-in z-10 text-center">
              <div className="w-20 h-20 bg-legal-navy rounded-3xl flex items-center justify-center border-4 border-slate-50 mx-auto mb-8 text-legal-gold shadow-xl rotate-3 hover:rotate-0 transition-transform">
                <Icon name="Shield" size={40} />
              </div>
              <h1 className="font-serif-legal text-2xl md:text-3xl font-bold text-legal-navy leading-tight mb-2 uppercase tracking-tighter">
                SILO KOORDINASI TIM
              </h1>
              <p className="text-[12px] text-legal-gold font-bold tracking-[0.4em] uppercase mb-10 border-b pb-6 border-slate-100 font-sans font-bold">
                SUI IURIS LAW OFFICE
              </p>

              <form onSubmit={handleAuth} className="space-y-5 text-left">
                {isReg && (
                  <Fragment>
                    <input
                      className="input-premium font-bold text-slate-800"
                      placeholder="Nama Lengkap Tim"
                      onChange={(e) =>
                        setForm({ ...form, name: e.target.value })
                      }
                      required
                    />
                    <select
                      className="input-premium font-bold text-slate-800"
                      onChange={(e) =>
                        setForm({ ...form, role: e.target.value })
                      }
                    >
                      <option value="litigasi">Tim Litigasi</option>
                      <option value="riset">Tim Riset</option>
                      <option value="admin">Administrator</option>
                    </select>
                  </Fragment>
                )}
                <input
                  className="input-premium font-bold text-slate-800"
                  type="email"
                  placeholder="Email Kantor"
                  onChange={(e) => setForm({ ...form, email: e.target.value })}
                  required
                />
                <div className="relative font-bold">
                  <input
                    className="input-premium font-bold text-slate-800"
                    type={showPass ? "text" : "password"}
                    placeholder="Kata Sandi"
                    onChange={(e) => setForm({ ...form, pass: e.target.value })}
                    required
                  />
                  <button
                    type="button"
                    onClick={() => setShowPass(!showPass)}
                    className="absolute right-5 top-5 text-slate-400 hover:text-legal-gold transition"
                  >
                    <Icon name={showPass ? "EyeOff" : "Eye"} size={22} />
                  </button>
                </div>
                <button
                  disabled={loading}
                  className="btn-action w-full mt-4 !py-5 font-black uppercase tracking-widest"
                >
                  {loading
                    ? "Menghubungkan..."
                    : isReg
                    ? "Buat Akun Tim"
                    : "Masuk Matrix"}
                </button>
              </form>
              <button
                onClick={() => setIsReg(!isReg)}
                className="mt-10 text-[10px] text-slate-400 font-black hover:text-legal-gold transition uppercase tracking-widest font-sans"
              >
                {isReg ? "Batal & Login" : "Registrasi Akun Baru"}
              </button>
            </div>
          </div>
        );
      }

      // --- MAIN DASHBOARD ---
      function MainDashboard({ user, userData }) {
        const isAdmin = userData?.role === "admin";
        const isLitigator = userData?.role === "litigasi" || isAdmin;
        const isResearcher = userData?.role === "riset" || isAdmin;

        const [activeTab, setActiveTab] = useState(
          isResearcher && !isLitigator ? "riset" : "litigasi"
        );
        const [search, setSearch] = useState("");
        const [expandedCase, setExpandedCase] = useState(null);
        const [ticketTab, setTicketTab] = useState("detail");
        const [researchSubTab, setResearchSubTab] = useState("berjalan");
        const [cases, setCases] = useState([]);
        const [researchTasks, setResearchTasks] = useState([]);
        const [caseLogs, setCaseLogs] = useState([]);
        const [caseDocs, setCaseDocs] = useState([]);
        const [loading, setLoading] = useState(false);
        const [modalType, setModalType] = useState(null);
        const [rtContent, setRtContent] = useState("");
        const [needResearch, setNeedResearch] = useState(false);
        const [selectedItem, setSelectedItem] = useState(null);
        const [expandedLogId, setExpandedLogId] = useState(null);
        const [isIndependentOpen, setIsIndependentOpen] = useState(false);
        const [showResearchLog, setShowResearchLog] = useState(null);

        const getCol = (name) =>
          db
            .collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection(name);

        // Fetch Base Data
        useEffect(() => {
          if (!user) return;
          const unsubCases = getCol("litigation_cases").onSnapshot((s) =>
            setCases(s.docs.map((d) => ({ id: d.id, ...d.data() })))
          );
          const unsubRes = getCol("research_tasks").onSnapshot((s) =>
            setResearchTasks(s.docs.map((d) => ({ id: d.id, ...d.data() })))
          );
          return () => {
            unsubCases();
            unsubRes();
          };
        }, [user]);

        // Fetch Logs and Docs for Expanded Case
        useEffect(() => {
          if (!expandedCase) {
            setCaseLogs([]);
            return;
          }
          const unsubLog = getCol("case_progress")
            .where("caseId", "==", expandedCase)
            .onSnapshot((s) => {
              setCaseLogs(
                s.docs.map((d) => ({ id: d.id, type: "progress", ...d.data() }))
              );
            });
          const unsubFiles = getCol("case_documents")
            .where("caseId", "==", expandedCase)
            .onSnapshot((s) =>
              setCaseDocs(s.docs.map((d) => ({ id: d.id, ...d.data() })))
            );
          return () => {
            unsubLog();
            unsubFiles();
          };
        }, [expandedCase]);

        // Smart Timeline Merging & Sorting
        const timelineMerged = React.useMemo(() => {
          if (!expandedCase) return [];
          const matchedResearch = researchTasks
            .filter((r) => r.caseId === expandedCase)
            .map((r) => ({ id: r.id, type: "research", ...r }));
          return [...caseLogs, ...matchedResearch].sort((a, b) => {
            const getLogTime = (item) => {
              // Prioritize most recent updates for sorting
              if (item.reviewedAt?.toDate)
                return item.reviewedAt.toDate().getTime();
              if (item.submittedAt?.toDate)
                return item.submittedAt.toDate().getTime();
              if (item.date) return new Date(item.date).getTime();
              if (item.createdAt?.toDate)
                return item.createdAt.toDate().getTime();
              return 0;
            };
            return getLogTime(b) - getLogTime(a);
          });
        }, [caseLogs, researchTasks, expandedCase]);

        // Tab Handling
        useEffect(() => {
          if (userData?.role === "riset" && !isAdmin) setActiveTab("riset");
          if (userData?.role === "litigasi" && !isAdmin)
            setActiveTab("litigasi");
        }, [userData, isAdmin]);

        const toggleCase = (id) => {
          if (expandedCase === id) {
            setExpandedCase(null);
          } else {
            setExpandedCase(id);
            setTicketTab("detail");
          }
        };
        const toggleLogInline = (logId) =>
          setExpandedLogId(expandedLogId === logId ? null : logId);

        // --- HANDLERS ---
        const handleAddDoc = async (e) => {
          e.preventDefault();
          const file = e.target.file.files[0];
          if (!file) return;
          setLoading(true);
          try {
            const ref = storage.ref(
              `case_files/${expandedCase}/${Date.now()}_${file.name}`
            );
            await ref.put(file);
            const url = await ref.getDownloadURL();
            await getCol("case_documents").add({
              caseId: expandedCase,
              title: e.target.docName.value,
              url,
              uploadedBy: userData.name,
              uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
            e.target.reset();
            alert("Berkas Diunggah.");
          } catch (e) {
            alert(e.message);
          } finally {
            setLoading(false);
          }
        };

        const handleAddProgress = async (e) => {
          e.preventDefault();
          setLoading(true);
          const fd = new FormData(e.target);
          const researchFile = e.target.resFile?.files[0];
          const progressPhoto = e.target.photo?.files[0];
          try {
            let photoUrl = selectedItem?.photoUrl || "";
            if (progressPhoto) {
              const ref = storage.ref(
                `progress_photos/${expandedCase}/${Date.now()}_${
                  progressPhoto.name
                }`
              );
              await ref.put(progressPhoto);
              photoUrl = await ref.getDownloadURL();
            }
            const progressData = {
              caseId: expandedCase,
              date: fd.get("date"),
              time: fd.get("time"),
              category: fd.get("cat"),
              location: fd.get("loc"),
              activity: fd.get("act"),
              kendala: fd.get("kendala") || "",
              rencana: fd.get("rencana") || "",
              description: rtContent,
              photoUrl: photoUrl,
              addedBy: userData.name,
            };
            if (selectedItem && modalType === "edit-log") {
              await getCol("case_progress")
                .doc(selectedItem.id)
                .update(progressData);
            } else {
              await getCol("case_progress").add({
                ...progressData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
            }

            if (needResearch && modalType !== "edit-log") {
              let fileUrl = "";
              if (researchFile) {
                const ref = storage.ref(
                  `research_reqs/${expandedCase}/${Date.now()}_${
                    researchFile.name
                  }`
                );
                await ref.put(researchFile);
                fileUrl = await ref.getDownloadURL();
              }
              await getCol("research_tasks").add({
                caseId: expandedCase,
                caseTitle: cases.find((x) => x.id === expandedCase)?.title,
                topic: fd.get("resTopic"),
                description: fd.get("resDesc"),
                status: "Open",
                referenceUrl: fileUrl,
                requester: userData.name,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
            }
            e.target.reset();
            setRtContent("");
            setNeedResearch(false);
            setModalType(null);
            setSelectedItem(null);
            alert("Data Tersimpan.");
          } catch (e) {
            alert(e.message);
          } finally {
            setLoading(false);
          }
        };

        const handleUpdatePriority = async (caseId, prio) => {
          if (!confirm(`Beri prioritas ${prio}?`)) return;
          await getCol("litigation_cases")
            .doc(caseId)
            .update({ priority: prio });
        };
        const handleAddEvaluation = async (logId) => {
          const evalText = prompt("Ketik arahan atau evaluasi supervisi:");
          if (!evalText) return;
          await getCol("case_progress")
            .doc(logId)
            .update({ adminEvaluation: evalText });
        };
        const handleAddResearchIdea = async (taskId) => {
          const idea = prompt("Ketik gagasan riset:");
          if (!idea) return;
          await getCol("research_tasks")
            .doc(taskId)
            .update({ adminIdeas: idea });
        };

        // FIX: Litigasi Feedback Handler (Action parameter passed directly from button)
        const submitLitigationFeedback = async (action) => {
          setLoading(true);
          const form = document.getElementById("feedback-form");
          const fd = new FormData(form);
          const isApproved = action === "APPROVE";
          const revFile = fd.get("revFile");
          try {
            let revFileUrl = selectedItem.revisionFileUrl || "";
            if (revFile && revFile.size > 0) {
              const ref = storage.ref(
                `research_revisions/${selectedItem.id}/${Date.now()}_${
                  revFile.name
                }`
              );
              await ref.put(revFile);
              revFileUrl = await ref.getDownloadURL();
            }
            await getCol("research_tasks")
              .doc(selectedItem.id)
              .update({
                litigationFeedback: fd.get("feedback"),
                status: isApproved ? "Completed" : "Revision Required",
                revisionFileUrl: revFileUrl,
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                reviewer: userData.name,
              });
            alert(
              isApproved
                ? "Kajian Selesai & Diarsipkan."
                : "Masukan Dikirim ke Tim Riset."
            );
            setModalType(null);
            setSelectedItem(null);
            setRtContent("");
          } catch (e) {
            alert(e.message);
          } finally {
            setLoading(false);
          }
        };

        const handleSaveCase = async (e) => {
          e.preventDefault();
          setLoading(true);
          const fd = new FormData(e.target);
          try {
            const payload = {
              number: fd.get("n"),
              title: fd.get("t"),
              type: fd.get("ty"),
              actionType: fd.get("at"),
              simerId: fd.get("sid"),
              category: fd.get("at") || "LITIGASI",
              description: rtContent,
              pic: userData.name,
              status: "Active",
            };
            if (selectedItem && modalType === "case") {
              await getCol("litigation_cases")
                .doc(selectedItem.id)
                .update(payload);
            } else {
              await getCol("litigation_cases").add({
                ...payload,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
            }
            setModalType(null);
            setRtContent("");
            setSelectedItem(null);
          } catch (err) {
            alert(err.message);
          } finally {
            setLoading(false);
          }
        };

        const handleUpdateResearchTask = async (e) => {
          e.preventDefault();
          setLoading(true);
          const fd = new FormData(e.target);
          try {
            await getCol("research_tasks")
              .doc(selectedItem.id)
              .update({ topic: fd.get("tp"), description: rtContent });
            setModalType(null);
            setRtContent("");
            setSelectedItem(null);
            alert("Riset Diperbarui.");
          } catch (e) {
            alert(e.message);
          } finally {
            setLoading(false);
          }
        };

        const handleResearchRequestStandalone = async (e) => {
          e.preventDefault();
          setLoading(true);
          const fd = new FormData(e.target);
          const file = e.target.resFile?.files[0];
          try {
            let url = "";
            if (file) {
              const ref = storage.ref(
                `research_reqs/standalone/${Date.now()}_${file.name}`
              );
              await ref.put(file);
              url = await ref.getDownloadURL();
            }
            const caseId = fd.get("caseId");
            await getCol("research_tasks").add({
              caseId: caseId,
              caseTitle:
                caseId === "independent"
                  ? "Kajian Umum"
                  : cases.find((c) => c.id === caseId)?.title,
              topic: fd.get("tp"),
              description: rtContent,
              status: "Open",
              referenceUrl: url,
              requester: userData.name,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
            alert("Riset Diajukan.");
            setIsIndependentOpen(false);
            setRtContent("");
          } catch (e) {
            alert(e.message);
          } finally {
            setLoading(false);
          }
        };

        const groupedResearch = researchTasks.reduce((acc, task) => {
          const key = task.caseTitle || "Kajian Umum";
          if (!acc[key]) acc[key] = [];
          acc[key].push(task);
          return acc;
        }, {});

        // --- RENDER ---
        return (
          <div className="max-w-6xl mx-auto px-6 pt-32 pb-24 space-y-12 fade-in text-left">
            {/* NEW DOSSIER FORM */}
            {modalType === "newCase" && (
              <div className="card-premium p-10 md:p-14 border-t-[12px] border-legal-gold fade-in shadow-2xl relative mb-12">
                <button
                  onClick={() => {
                    setModalType(null);
                    setRtContent("");
                  }}
                  className="absolute right-8 top-8 text-slate-300 hover:text-red-500 transition-colors"
                >
                  <Icon name="X" size={24} />
                </button>
                <h2 className="font-serif-legal text-3xl font-bold text-legal-navy mb-10 uppercase text-center font-bold">
                  Registrasi Dossier Perkara Baru
                </h2>
                <form
                  onSubmit={handleSaveCase}
                  className="space-y-6 text-slate-800 font-bold"
                >
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="space-y-6 text-left">
                      <div>
                        <label className="text-[11px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          Jenis Tindakan
                        </label>
                        <select
                          name="at"
                          className="input-premium font-bold text-slate-800"
                        >
                          <option value="LITIGASI">LITIGASI</option>
                          <option value="NON-LITIGASI">NON-LITIGASI</option>
                        </select>
                      </div>
                      <div>
                        <label className="text-[11px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          Klasifikasi Perkara
                        </label>
                        <select
                          name="ty"
                          className="input-premium font-bold text-slate-800"
                        >
                          <option>PERDATA</option>
                          <option>PIDANA</option>
                          <option>TUN</option>
                          <option>NIAGA</option>
                        </select>
                      </div>
                      <div>
                        <label className="text-[11px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          ID SIMER (Sinkronisasi)
                        </label>
                        <input
                          name="sid"
                          className="input-premium font-bold text-slate-800"
                          placeholder="SMR-2026-XXXX"
                        />
                      </div>
                    </div>
                    <div className="space-y-6 text-left">
                      <div>
                        <label className="text-[11px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          Arsip ID / Nomor Perkara
                        </label>
                        <input
                          name="n"
                          className="input-premium font-mono font-bold text-slate-800 uppercase"
                          placeholder="e.g. 112/SILO/..."
                          required
                        />
                      </div>
                      <div>
                        <label className="text-[11px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          Nama Klien / Subjek
                        </label>
                        <input
                          name="t"
                          className="input-premium font-bold text-slate-800"
                          required
                        />
                      </div>
                    </div>
                  </div>
                  <div>
                    <label className="text-[11px] font-bold text-slate-400 uppercase mb-2 block font-sans font-bold">
                      Deskripsi Pokok Perkara
                    </label>
                    <RichEditor
                      value={rtContent}
                      onChange={setRtContent}
                      height="200px"
                    />
                  </div>
                  <div className="flex justify-end gap-6 pt-8 border-t">
                    <button
                      type="button"
                      onClick={() => {
                        setModalType(null);
                        setRtContent("");
                      }}
                      className="px-10 py-4 text-[12px] font-black uppercase text-slate-400 tracking-widest"
                    >
                      Batal
                    </button>
                    <button
                      disabled={loading}
                      className="btn-action px-20 font-black text-white shadow-xl"
                    >
                      Launch Perkara üõ°Ô∏è
                    </button>
                  </div>
                </form>
              </div>
            )}

            {/* SEARCH & NAV DOCK */}
            {!modalType && (
              <div className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm gap-6 fade-in font-bold">
                <div className="nav-dock font-bold">
                  {(isLitigator || isAdmin) && (
                    <div
                      onClick={() => setActiveTab("litigasi")}
                      className={`nav-dock-item ${
                        activeTab === "litigasi" ? "nav-dock-active" : ""
                      }`}
                    >
                      üõ°Ô∏è Perkara
                    </div>
                  )}
                  {(isResearcher || isAdmin) && (
                    <div
                      onClick={() => setActiveTab("riset")}
                      className={`nav-dock-item ${
                        activeTab === "riset" ? "nav-dock-active" : ""
                      }`}
                    >
                      üîé Riset
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-4 w-full md:w-auto font-bold">
                  <div className="relative flex-1">
                    <input
                      className="input-premium !py-3 !text-xs !bg-slate-50 border-transparent focus:!border-legal-gold text-slate-800"
                      placeholder="Cari dossier..."
                      value={search}
                      onChange={(e) => setSearch(e.target.value)}
                    />
                    <div className="absolute right-5 top-3.5 text-slate-300">
                      <Icon name="Search" size={16} />
                    </div>
                  </div>
                  {isLitigator && !isAdmin && activeTab === "litigasi" && (
                    <button
                      onClick={() => {
                        setRtContent("");
                        setModalType("newCase");
                      }}
                      className="btn-action !py-3 font-black text-white uppercase"
                    >
                      <Icon name="Plus" size={16} /> Dossier Baru
                    </button>
                  )}
                </div>
              </div>
            )}

            {/* TAB: PERKARA */}
            {activeTab === "litigasi" && (isLitigator || isAdmin) && (
              <div className="grid grid-cols-1 gap-8">
                {cases
                  .filter((c) =>
                    (c.title + c.number + (c.simerId || ""))
                      .toLowerCase()
                      .includes(search.toLowerCase())
                  )
                  .map((c) => {
                    const isExp = expandedCase === c.id;
                    const theme = getThemeByClassification(c.type);
                    const isNonLit = c.actionType === "NON-LITIGASI";
                    const isFinished =
                      c.status === "Finished" || c.status === "Completed";
                    const prioClass =
                      c.priority === "HIGH"
                        ? "prio-high"
                        : c.priority === "MEDIUM"
                        ? "prio-medium"
                        : "prio-normal";

                    return (
                      <div
                        key={c.id}
                        className={`card-premium transition-all ${
                          isExp
                            ? "border-legal-gold ring-8 ring-legal-gold/5 shadow-2xl scale-[1.01]"
                            : ""
                        } border-l-[12px] ${theme.border}`}
                      >
                        <div
                          className="p-8 flex items-start gap-8 cursor-pointer"
                          onClick={() => toggleCase(c.id)}
                        >
                          {!isExp && (
                            <div className="hidden md:flex flex-col border-r pr-8 text-center min-w-[150px] font-bold">
                              <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-1">
                                Dossier
                              </span>
                              <span className="text-[18px] font-bold font-serif-legal text-legal-navy uppercase tracking-tighter">
                                {c.number}
                              </span>
                              <div className="mt-4 flex flex-col gap-1.5">
                                <span className={`badge-type ${theme.badge}`}>
                                  {c.type}
                                </span>
                                <span
                                  className={`text-[8px] font-black uppercase tracking-wider py-1.5 border rounded-lg shadow-sm flex items-center justify-center gap-1.5 ${
                                    isNonLit
                                      ? "bg-amber-600 text-white"
                                      : "bg-legal-navy text-white"
                                  }`}
                                >
                                  <Icon
                                    name={isNonLit ? "Briefcase" : "Hammer"}
                                    size={8}
                                  />{" "}
                                  {c.actionType || "LITIGASI"}
                                </span>
                                {c.priority && (
                                  <span
                                    className={`badge-type ${prioClass} text-center font-black uppercase`}
                                  >
                                    <Icon
                                      name="Star"
                                      size={8}
                                      className="inline mr-1"
                                    />
                                    {c.priority}
                                  </span>
                                )}
                              </div>
                            </div>
                          )}
                          <div className="flex-1 overflow-hidden">
                            <div className="flex justify-between items-center mb-1 text-left font-bold">
                              <div className="flex items-center gap-3">
                                {isExp && (
                                  <span
                                    className={`text-[10px] font-black uppercase tracking-widest font-sans px-3 py-1 rounded-lg ${
                                      isNonLit
                                        ? "bg-amber-100 text-amber-700"
                                        : "bg-slate-100 text-slate-700"
                                    }`}
                                  >
                                    #{c.number} ‚Ä¢ {c.actionType || "LITIGASI"}
                                  </span>
                                )}
                                {c.simerId && (
                                  <span className="bg-white text-slate-600 px-2 py-1 rounded-lg text-[8px] font-black uppercase border border-slate-200 flex items-center gap-1.5 shadow-sm">
                                    <Icon
                                      name="RefreshCw"
                                      size={8}
                                      className="text-legal-gold"
                                    />{" "}
                                    ID SIMER: {c.simerId}
                                  </span>
                                )}
                                {isFinished && (
                                  <span className="bg-green-50 text-green-600 px-3 py-1 rounded-full text-[9px] font-bold border border-green-200">
                                    SELESAI
                                  </span>
                                )}
                              </div>
                              <div className="flex items-center gap-4">
                                {isExp && isLitigator && !isAdmin && (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      setSelectedItem(c);
                                      setRtContent(c.description);
                                      setModalType("case");
                                    }}
                                    className="p-2 text-legal-gold hover:bg-slate-50 rounded-xl transition"
                                  >
                                    <Icon name="Edit" size={18} />
                                  </button>
                                )}
                                <Icon
                                  name={isExp ? "Minimize" : "Maximize"}
                                  className="text-slate-200"
                                />
                              </div>
                            </div>
                            <h3
                              className={`font-serif-legal font-bold text-legal-navy leading-tight text-left flex items-center gap-3 ${
                                isExp ? "text-2xl mb-4" : "text-3xl font-bold"
                              }`}
                            >
                              <Icon
                                name={theme.icon}
                                size={isExp ? 24 : 32}
                                className="text-slate-300 shrink-0"
                              />
                              {c.title}
                            </h3>
                            {!isExp && (
                              <div
                                className="mt-4 text-sm text-slate-400 font-serif-legal italic line-clamp-2 text-left"
                                dangerouslySetInnerHTML={{
                                  __html: c.description,
                                }}
                              ></div>
                            )}

                            {isExp && (
                              <div
                                className="mt-10 pt-10 border-t border-slate-100 animate-fade"
                                onClick={(e) => e.stopPropagation()}
                              >
                                <div className="flex justify-center gap-4 mb-12 font-bold">
                                  <button
                                    onClick={() => setTicketTab("detail")}
                                    className={`tab-btn ${
                                      ticketTab === "detail" ? "tab-active" : ""
                                    }`}
                                  >
                                    üîç Detail
                                  </button>
                                  {!isAdmin && isLitigator && (
                                    <button
                                      onClick={() => {
                                        setRtContent("");
                                        setTicketTab("update");
                                      }}
                                      className={`tab-btn ${
                                        ticketTab === "update"
                                          ? "tab-active"
                                          : ""
                                      }`}
                                    >
                                      üìù Update
                                    </button>
                                  )}
                                  <button
                                    onClick={() => setTicketTab("docs")}
                                    className={`tab-btn ${
                                      ticketTab === "docs" ? "tab-active" : ""
                                    }`}
                                  >
                                    üìÅ Berkas
                                  </button>
                                  <button
                                    onClick={() => setTicketTab("timeline")}
                                    className={`tab-btn ${
                                      ticketTab === "timeline"
                                        ? "tab-active"
                                        : ""
                                    }`}
                                  >
                                    ‚è≥ Log
                                  </button>
                                </div>

                                {ticketTab === "detail" && (
                                  <div className="fade-in space-y-10 text-left font-bold">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8 text-slate-800">
                                      <div className="bg-slate-50 p-8 rounded-3xl border border-slate-100 shadow-inner">
                                        <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 font-sans">
                                          Identitas Registrasi:
                                        </p>
                                        <p className="text-lg font-bold text-legal-navy font-serif-legal mb-2">
                                          {c.number}
                                        </p>
                                        <div className="flex flex-col gap-1.5">
                                          <span
                                            className={`badge-type w-fit ${theme.badge}`}
                                          >
                                            {c.type}
                                          </span>
                                          <span className="text-[8px] font-black uppercase text-slate-400 px-2 py-0.5 border rounded-lg w-fit bg-white">
                                            {c.actionType || "LITIGASI"}
                                          </span>
                                        </div>
                                      </div>
                                      <div className="bg-slate-50 p-8 rounded-3xl border border-slate-100 col-span-2 shadow-inner">
                                        <p className="text-[9px] font-black text-slate-400 uppercase mb-2 font-sans font-bold">
                                          Penanggung Jawab:
                                        </p>
                                        <p className="text-lg font-bold text-legal-navy font-serif-legal uppercase mb-4">
                                          {c.pic || "Direksi SILO"}
                                        </p>
                                        {c.simerId && (
                                          <div className="pt-2 border-t border-slate-200 flex items-center gap-3">
                                            <div className="w-8 h-8 bg-white rounded-lg flex items-center justify-center text-legal-gold border shadow-sm">
                                              <Icon
                                                name="RefreshCw"
                                                size={14}
                                              />
                                            </div>
                                            <div>
                                              <p className="text-[8px] text-slate-400 uppercase font-black">
                                                ID SIMER
                                              </p>
                                              <p className="text-sm font-mono text-slate-700 font-bold">
                                                {c.simerId}
                                              </p>
                                            </div>
                                          </div>
                                        )}
                                      </div>
                                    </div>
                                    <div className="bg-white p-10 rounded-[2.5rem] border border-slate-100 relative overflow-hidden text-left shadow-sm">
                                      <div className="absolute top-0 right-0 p-8 opacity-[0.05] rotate-12 text-legal-navy">
                                        <Icon name="Shield" size={150} />
                                      </div>
                                      <p className="text-[10px] font-bold text-legal-gold uppercase tracking-[0.3em] mb-6 border-b pb-3 font-sans text-left">
                                        Uraian Pokok Masalah Perkara:
                                      </p>
                                      <div
                                        className="text-[18px] text-slate-700 leading-relaxed italic font-serif-legal text-left"
                                        dangerouslySetInnerHTML={{
                                          __html: c.description,
                                        }}
                                      ></div>
                                    </div>
                                  </div>
                                )}

                                {ticketTab === "update" &&
                                  !isAdmin &&
                                  isLitigator && (
                                    <form
                                      onSubmit={handleAddProgress}
                                      className="space-y-6 max-w-4xl mx-auto fade-in font-bold"
                                    >
                                      <div className="grid grid-cols-2 gap-6 text-left font-bold text-slate-800">
                                        <div>
                                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                                            Tanggal Agenda
                                          </label>
                                          <input
                                            type="date"
                                            name="date"
                                            className="input-premium font-bold text-slate-800"
                                            required
                                          />
                                        </div>
                                        <div>
                                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                                            Waktu Laporan
                                          </label>
                                          <input
                                            type="time"
                                            name="time"
                                            className="input-premium font-bold text-slate-800"
                                            required
                                          />
                                        </div>
                                      </div>

                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-left font-bold text-slate-800">
                                        <div>
                                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                                            Kategori Aktivitas (SIMER)
                                          </label>
                                          <select
                                            name="cat"
                                            className="input-premium font-bold text-slate-800"
                                          >
                                            <option value="SIDANG">
                                              PERSIDANGAN
                                            </option>
                                            <option value="LAPANGAN">
                                              INVESTIGASI/LAPANGAN
                                            </option>
                                            <option value="ADMIN">
                                              ADMINISTRASI KANTOR
                                            </option>
                                            <option value="KOORDINASI">
                                              KOORDINASI INTERNAL/KLIEN
                                            </option>
                                          </select>
                                        </div>
                                        <div>
                                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                                            Lokasi Pelaksanaan
                                          </label>
                                          <div className="relative">
                                            <input
                                              name="loc"
                                              className="input-premium font-bold text-slate-800"
                                              placeholder="e.g. PN Jakarta Selatan"
                                              required
                                            />
                                            <div className="absolute right-4 top-3 text-slate-300">
                                              <Icon name="MapPin" size={16} />
                                            </div>
                                          </div>
                                        </div>
                                      </div>

                                      <div className="text-left font-bold text-slate-800 font-sans">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                                          Header Aktivitas
                                        </label>
                                        <input
                                          name="act"
                                          className="input-premium font-bold text-slate-800"
                                          placeholder="e.g. Pemeriksaan Saksi..."
                                          required
                                        />
                                      </div>

                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-left font-bold text-slate-800">
                                        <div>
                                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans flex items-center gap-2">
                                            <Icon
                                              name="AlertCircle"
                                              size={12}
                                              className="text-red-500"
                                            />{" "}
                                            Kendala yang Dihadapi
                                          </label>
                                          <textarea
                                            name="kendala"
                                            className="input-premium h-20 text-slate-800 font-bold"
                                            placeholder="Tulis kendala jika ada..."
                                          ></textarea>
                                        </div>
                                        <div>
                                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans flex items-center gap-2">
                                            <Icon
                                              name="Target"
                                              size={12}
                                              className="text-emerald-500"
                                            />{" "}
                                            Rencana Kedepan / Tindak Lanjut
                                          </label>
                                          <textarea
                                            name="rencana"
                                            className="input-premium h-20 text-slate-800 font-bold"
                                            placeholder="Langkah strategis selanjutnya..."
                                          ></textarea>
                                        </div>
                                      </div>

                                      <div className="bg-slate-50 p-6 rounded-2xl border border-dashed border-slate-200">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-3 block font-sans flex items-center gap-2">
                                          <Icon name="Camera" size={14} />{" "}
                                          Upload Foto Dokumentasi
                                        </label>
                                        <input
                                          type="file"
                                          name="photo"
                                          accept="image/*"
                                          className="text-xs font-bold text-slate-500 bg-white p-3 rounded-xl border w-full"
                                        />
                                      </div>

                                      <RichEditor
                                        value={rtContent}
                                        onChange={setRtContent}
                                      />

                                      <div className="pt-6 border-t border-dashed font-bold">
                                        <div className="flex items-center gap-3 mb-6">
                                          <input
                                            type="checkbox"
                                            checked={needResearch}
                                            onChange={(e) =>
                                              setNeedResearch(e.target.checked)
                                            }
                                            className="w-6 h-6 accent-legal-gold"
                                          />
                                          <span className="text-xs font-bold uppercase text-legal-navy tracking-wider font-bold">
                                            Delegasikan Kajian Riset Hukum üîé
                                          </span>
                                        </div>
                                        {needResearch && (
                                          <div className="p-8 bg-slate-50 rounded-3xl border border-slate-200 space-y-4 mb-8 text-left text-slate-800 font-bold shadow-inner">
                                            <input
                                              name="resTopic"
                                              className="input-premium font-bold text-slate-800"
                                              placeholder="Judul Kajian..."
                                              required={needResearch}
                                            />
                                            <textarea
                                              name="resDesc"
                                              className="input-premium h-24 text-slate-800 font-bold"
                                              placeholder="Pertanyaan hukum mendasar..."
                                              required={needResearch}
                                            ></textarea>
                                            <div className="flex flex-col gap-2 mt-4 text-left">
                                              <label className="text-[10px] font-bold text-slate-400 uppercase">
                                                Lampirkan Berkas Dasar Riset
                                                (PDF)
                                              </label>
                                              <input
                                                type="file"
                                                name="resFile"
                                                className="text-xs font-bold font-sans bg-white p-3 rounded-xl border w-full"
                                              />
                                            </div>
                                          </div>
                                        )}
                                        <div className="flex justify-end pt-6 border-t border-dashed text-white font-bold">
                                          <button
                                            disabled={loading}
                                            className="btn-action px-20 shadow-xl uppercase font-black text-white font-bold"
                                          >
                                            Sinkronisasi & Simpan Update üõ°Ô∏è
                                          </button>
                                        </div>
                                      </div>
                                    </form>
                                  )}

                                {ticketTab === "docs" && (
                                  <div className="space-y-10 fade-in text-left font-bold text-slate-800">
                                    <div className="bg-slate-50 p-10 rounded-[2.5rem] border border-slate-200 shadow-inner">
                                      <div className="flex items-center gap-3 mb-6">
                                        <div className="p-2 bg-legal-navy text-legal-gold rounded-lg">
                                          <Icon name="Upload" size={16} />
                                        </div>
                                        <h4 className="text-xs font-black uppercase tracking-widest text-legal-navy">
                                          Unggah Dokumen Perkara
                                        </h4>
                                      </div>
                                      <form
                                        onSubmit={handleAddDoc}
                                        className="flex flex-col md:flex-row items-end gap-6 text-left"
                                      >
                                        <div className="flex-1 text-left font-bold text-slate-800 w-full">
                                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans font-bold">
                                            Nama Berkas
                                          </label>
                                          <input
                                            name="docName"
                                            className="input-premium font-bold text-slate-800"
                                            placeholder="e.g. Surat Kuasa, Eksepsi..."
                                            required
                                          />
                                        </div>
                                        <div className="text-left font-bold text-slate-800 font-sans font-bold w-full md:w-auto">
                                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans font-bold">
                                            Pilih File (PDF)
                                          </label>
                                          <input
                                            type="file"
                                            name="file"
                                            className="text-xs font-bold font-sans font-bold bg-white p-3 rounded-xl border border-slate-200 w-full"
                                            required
                                          />
                                        </div>
                                        <button
                                          disabled={loading}
                                          className="btn-action font-black text-white uppercase font-bold px-10 shadow-lg w-full md:w-auto"
                                        >
                                          {loading
                                            ? "Proses..."
                                            : "Simpan Berkas"}
                                        </button>
                                      </form>
                                    </div>
                                    <div className="pt-6">
                                      <div className="flex items-center justify-between mb-8 pb-4 border-b">
                                        <div className="flex items-center gap-3">
                                          <div className="text-slate-400">
                                            <Icon name="Folder" size={24} />
                                          </div>
                                          <h4 className="text-sm font-black uppercase tracking-widest text-slate-600">
                                            Direktori Berkas Perkara
                                          </h4>
                                        </div>
                                        <span className="text-[10px] bg-slate-100 px-3 py-1 rounded-full font-bold text-slate-500">
                                          {caseDocs.length} Dokumen
                                        </span>
                                      </div>
                                      {caseDocs.length > 0 ? (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 font-bold">
                                          {caseDocs.map((d) => (
                                            <div
                                              key={d.id}
                                              className="bg-white p-6 rounded-3xl border border-slate-100 flex items-center justify-between hover:border-legal-gold shadow-sm group"
                                            >
                                              <div className="flex items-center gap-4 text-left overflow-hidden">
                                                <div className="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-legal-gold shrink-0 shadow-inner group-hover:bg-legal-navy transition-colors">
                                                  <Icon
                                                    name="FileText"
                                                    size={24}
                                                  />
                                                </div>
                                                <div className="overflow-hidden text-left font-bold">
                                                  <h5 className="font-bold text-legal-navy text-xs truncate uppercase mb-1">
                                                    {d.title}
                                                  </h5>
                                                  <p className="text-[8px] text-slate-400 uppercase tracking-widest font-bold">
                                                    PJ: {d.uploadedBy}
                                                  </p>
                                                </div>
                                              </div>
                                              <div className="flex gap-2">
                                                <a
                                                  href={d.url}
                                                  target="_blank"
                                                  className="p-3 bg-slate-50 text-slate-400 hover:text-legal-navy rounded-2xl shadow-sm"
                                                >
                                                  <Icon
                                                    name="Download"
                                                    size={18}
                                                  />
                                                </a>
                                                {isAdmin && (
                                                  <button
                                                    onClick={async () => {
                                                      if (
                                                        confirm(
                                                          "Hapus berkas ini?"
                                                        )
                                                      )
                                                        await getCol(
                                                          "case_documents"
                                                        )
                                                          .doc(d.id)
                                                          .delete();
                                                    }}
                                                    className="p-3 bg-slate-50 text-slate-300 hover:text-red-500 rounded-2xl shadow-sm"
                                                  >
                                                    <Icon
                                                      name="Trash"
                                                      size={18}
                                                    />
                                                  </button>
                                                )}
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      ) : (
                                        <div className="py-20 text-center bg-white rounded-[2.5rem] border border-dashed border-slate-200">
                                          <div className="text-slate-200 mb-4 flex justify-center">
                                            <Icon name="Folder" size={64} />
                                          </div>
                                          <p className="text-sm italic text-slate-400">
                                            Direktori kosong.
                                          </p>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                )}

                                {ticketTab === "timeline" && (
                                  <div className="relative max-w-4xl mx-auto pt-10 text-left font-bold text-slate-800">
                                    <div className="timeline-spine"></div>
                                    {timelineMerged.map((log) => (
                                      <div
                                        key={log.id}
                                        className="mb-12 pl-20 relative group/item text-left font-bold"
                                      >
                                        <div
                                          className={`absolute left-[34px] top-[24px] w-4 h-4 rounded-full bg-white border-4 ${
                                            log.type === "research"
                                              ? "border-indigo-600 shadow-[0_0_10px_rgba(79,70,229,0.3)]"
                                              : "border-legal-navy"
                                          } shadow-md z-10 transition-transform group-hover/item:scale-125`}
                                        ></div>
                                        <div
                                          className={`p-8 rounded-[2.5rem] border transition-all ${
                                            log.type === "research"
                                              ? "bg-indigo-50/50 border-indigo-100"
                                              : "bg-slate-50/50 border-slate-100"
                                          } hover:bg-white hover:shadow-2xl text-left shadow-sm`}
                                          onClick={() =>
                                            toggleLogInline(log.id)
                                          }
                                        >
                                          <div className="flex justify-between items-center mb-6">
                                            <div className="flex items-center gap-3 font-bold">
                                              <span className="text-[10px] font-black text-legal-gold tracking-widest uppercase font-sans">
                                                {formatDate(
                                                  log.date || log.createdAt
                                                )}
                                              </span>
                                              {log.type === "research" && (
                                                <span className="bg-indigo-600 text-white px-2 py-0.5 rounded uppercase font-bold text-[8px] font-sans font-bold">
                                                  üî¨ Riset ‚Ä¢ {log.status}
                                                </span>
                                              )}
                                              <Icon
                                                name={
                                                  expandedLogId === log.id
                                                    ? "Minimize"
                                                    : "Maximize"
                                                }
                                                size={14}
                                                className="text-slate-300 font-bold"
                                              />
                                            </div>
                                            <div className="flex items-center gap-2 opacity-0 group-hover/item:opacity-100 transition-opacity">
                                              {log.type === "research" &&
                                                log.status === "Submitted" &&
                                                isLitigator && (
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      setSelectedItem(log);
                                                      setRtContent("");
                                                      setModalType(
                                                        "litigation-feedback"
                                                      );
                                                    }}
                                                    className="px-4 py-1.5 bg-royal-600 text-white text-[9px] font-bold rounded-full uppercase hover:bg-royal-700 transition"
                                                  >
                                                    <Icon
                                                      name="CheckCircle"
                                                      size={10}
                                                    />{" "}
                                                    Review Riset
                                                  </button>
                                                )}
                                              {isLitigator && (
                                                <Fragment>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      setSelectedItem(log);
                                                      setRtContent(
                                                        log.description
                                                      );
                                                      setModalType(
                                                        log.type === "research"
                                                          ? "edit-research"
                                                          : "edit-log"
                                                      );
                                                    }}
                                                    className="p-2 text-slate-200 hover:text-legal-gold transition-colors font-bold"
                                                  >
                                                    <Icon
                                                      name="Edit"
                                                      size={16}
                                                    />
                                                  </button>
                                                  <button
                                                    onClick={(e) => {
                                                      e.stopPropagation();
                                                      if (confirm("Hapus log?"))
                                                        getCol(
                                                          log.type ===
                                                            "research"
                                                            ? "research_tasks"
                                                            : "case_progress"
                                                        )
                                                          .doc(log.id)
                                                          .delete();
                                                    }}
                                                    className="p-2 text-slate-200 hover:text-red-500 transition-colors font-bold"
                                                  >
                                                    <Icon
                                                      name="Trash"
                                                      size={16}
                                                    />
                                                  </button>
                                                </Fragment>
                                              )}
                                            </div>
                                          </div>
                                          <div className="mb-4">
                                            {log.category && (
                                              <div className="flex items-center gap-2 mb-2">
                                                <span className="bg-legal-navy text-white text-[8px] font-black uppercase px-2 py-0.5 rounded-lg">
                                                  {log.category}
                                                </span>
                                                {log.location && (
                                                  <span className="text-[9px] text-slate-400 italic flex items-center gap-1">
                                                    <Icon
                                                      name="MapPin"
                                                      size={8}
                                                    />{" "}
                                                    {log.location}
                                                  </span>
                                                )}
                                              </div>
                                            )}
                                            <h4 className="font-serif-legal font-bold text-legal-navy text-2xl mb-2 leading-tight font-bold text-left">
                                              {log.type === "progress"
                                                ? log.activity
                                                : log.topic}
                                            </h4>
                                          </div>

                                          {/* TAMPILAN FINAL (ALWAYS SHOW IF COMPLETED) */}
                                          {log.type === "research" &&
                                            log.status === "Completed" && (
                                              <div
                                                className="mt-6 mb-4 bg-green-50 p-6 rounded-2xl border border-green-200 animate-fade"
                                                onClick={(e) =>
                                                  e.stopPropagation()
                                                }
                                              >
                                                <div className="flex items-center gap-3 mb-4">
                                                  <div className="p-2 bg-green-600 text-white rounded-lg shadow-md">
                                                    <Icon
                                                      name="CheckCircle"
                                                      size={14}
                                                    />
                                                  </div>
                                                  <h4 className="text-sm font-black uppercase tracking-widest text-green-700">
                                                    Hasil Kajian Final
                                                  </h4>
                                                </div>
                                                <div
                                                  className="text-sm text-slate-800 italic font-serif-legal leading-relaxed mb-4"
                                                  dangerouslySetInnerHTML={{
                                                    __html: log.analysisResult,
                                                  }}
                                                ></div>
                                                {log.resultUrl && (
                                                  <a
                                                    href={log.resultUrl}
                                                    target="_blank"
                                                    className="inline-flex items-center gap-2 px-6 py-2.5 bg-green-600 text-white rounded-xl text-[10px] font-black uppercase shadow-lg hover:bg-green-700 transition"
                                                  >
                                                    <Icon
                                                      name="Download"
                                                      size={14}
                                                    />{" "}
                                                    Unduh Laporan (PDF)
                                                  </a>
                                                )}
                                              </div>
                                            )}

                                          {/* TAMPILAN MENUNGGU REVIEW */}
                                          {log.type === "research" &&
                                            log.status === "Submitted" && (
                                              <div className="mt-6 mb-4 bg-amber-50 p-6 rounded-2xl border border-amber-200 animate-fade">
                                                <p className="text-[10px] font-black uppercase tracking-widest text-amber-700 mb-2">
                                                  Pembaruan: Menunggu Review
                                                  Litigasi
                                                </p>
                                                <div
                                                  className="text-sm text-slate-800 italic font-serif-legal line-clamp-2"
                                                  dangerouslySetInnerHTML={{
                                                    __html: log.analysisResult,
                                                  }}
                                                ></div>
                                              </div>
                                            )}

                                          {expandedLogId === log.id && (
                                            <div className="fade-in space-y-6 text-left font-bold mt-4 border-t pt-4">
                                              {log.photoUrl && (
                                                <div className="mb-4">
                                                  <img
                                                    src={log.photoUrl}
                                                    className="progress-image-preview"
                                                    alt="Dokumentasi"
                                                  />
                                                </div>
                                              )}
                                              {(log.kendala || log.rencana) && (
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
                                                  {log.kendala && (
                                                    <div className="bg-red-50 p-4 rounded-2xl border border-red-100">
                                                      <p className="text-[8px] font-black text-red-600 uppercase mb-1 flex items-center gap-1">
                                                        <Icon
                                                          name="AlertCircle"
                                                          size={10}
                                                        />{" "}
                                                        Kendala:
                                                      </p>
                                                      <p className="text-xs text-slate-700 italic">
                                                        {log.kendala}
                                                      </p>
                                                    </div>
                                                  )}
                                                  {log.rencana && (
                                                    <div className="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                                                      <p className="text-[8px] font-black text-emerald-600 uppercase mb-1 flex items-center gap-1">
                                                        <Icon
                                                          name="Target"
                                                          size={10}
                                                        />{" "}
                                                        Rencana:
                                                      </p>
                                                      <p className="text-xs text-slate-700 italic">
                                                        {log.rencana}
                                                      </p>
                                                    </div>
                                                  )}
                                                </div>
                                              )}

                                              {/* LINI MASA KAJIAN (Sub-timeline) */}
                                              {log.type === "research" && (
                                                <div className="mt-8 border-t pt-8">
                                                  <div className="flex items-center justify-between mb-6">
                                                    <h5 className="text-lg font-black uppercase text-indigo-600 tracking-widest flex items-center gap-2 font-sans">
                                                      <Icon
                                                        name="History"
                                                        size={20}
                                                      />{" "}
                                                      Lini Masa Log Aktifitas
                                                      Kajian
                                                    </h5>
                                                    <button
                                                      onClick={(e) => {
                                                        e.stopPropagation();
                                                        setShowResearchLog(
                                                          showResearchLog ===
                                                            log.id
                                                            ? null
                                                            : log.id
                                                        );
                                                      }}
                                                      className="text-[9px] font-bold text-slate-400 hover:text-indigo-600 uppercase"
                                                    >
                                                      {showResearchLog ===
                                                      log.id
                                                        ? "√ó Sembunyikan"
                                                        : "+ Tampilkan Proses"}
                                                    </button>
                                                  </div>

                                                  {showResearchLog ===
                                                    log.id && (
                                                    <div className="space-y-6 relative pl-6 border-l-2 border-indigo-100 ml-2 animate-fade">
                                                      <div className="relative">
                                                        <div className="absolute -left-[31px] top-1 w-3 h-3 rounded-full bg-indigo-600"></div>
                                                        <p className="text-[8px] font-black text-indigo-400 uppercase">
                                                          Tahap 1: Delegasi Awal
                                                        </p>
                                                        <p className="text-xs font-bold text-legal-navy">
                                                          {log.addedBy ||
                                                            log.requester}{" "}
                                                          mendelegasikan riset.
                                                        </p>
                                                      </div>
                                                      {log.submittedAt && (
                                                        <div className="relative">
                                                          <div className="absolute -left-[31px] top-1 w-3 h-3 rounded-full bg-amber-500"></div>
                                                          <p className="text-[8px] font-black text-amber-500 uppercase">
                                                            Tahap 2: Pengiriman
                                                            Hasil
                                                          </p>
                                                          <p className="text-xs font-bold text-legal-navy">
                                                            Dikirim oleh{" "}
                                                            {log.completedBy}.
                                                          </p>
                                                          <p className="text-[10px] text-slate-400 italic mt-1">
                                                            {formatDate(
                                                              log.submittedAt
                                                            )}
                                                          </p>
                                                        </div>
                                                      )}
                                                      {log.reviewedAt && (
                                                        <div className="relative">
                                                          <div
                                                            className={`absolute -left-[31px] top-1 w-3 h-3 rounded-full ${
                                                              log.status ===
                                                              "Completed"
                                                                ? "bg-green-600"
                                                                : "bg-red-500"
                                                            }`}
                                                          ></div>
                                                          <p
                                                            className={`text-[8px] font-black uppercase ${
                                                              log.status ===
                                                              "Completed"
                                                                ? "text-green-600"
                                                                : "text-red-500"
                                                            }`}
                                                          >
                                                            Tahap 3:{" "}
                                                            {log.status ===
                                                            "Completed"
                                                              ? "Penyelesaian & Arsip"
                                                              : "Instruksi Revisi"}
                                                          </p>
                                                          <p className="text-xs font-bold text-legal-navy">
                                                            Review{" "}
                                                            {log.reviewer}.
                                                          </p>
                                                          <p className="text-[10px] text-slate-400 italic mt-1">
                                                            {formatDate(
                                                              log.reviewedAt
                                                            )}
                                                          </p>
                                                        </div>
                                                      )}
                                                    </div>
                                                  )}
                                                </div>
                                              )}

                                              <div
                                                className="text-slate-600 text-sm italic font-serif-legal border-l-4 border-slate-200 pl-6 mb-6 text-left"
                                                dangerouslySetInnerHTML={{
                                                  __html: log.description,
                                                }}
                                              ></div>

                                              {log.litigationFeedback &&
                                                log.status !== "Completed" && (
                                                  <div className="bg-indigo-50 p-6 rounded-2xl border border-indigo-100 shadow-sm">
                                                    <p className="text-[9px] font-black text-indigo-700 uppercase mb-2 flex items-center gap-2">
                                                      <Icon
                                                        name="MessageSquare"
                                                        size={12}
                                                      />{" "}
                                                      Feedback Litigasi:
                                                    </p>
                                                    <p className="text-sm text-slate-800 italic font-serif-legal">
                                                      {log.litigationFeedback}
                                                    </p>
                                                  </div>
                                                )}
                                            </div>
                                          )}
                                          <p className="text-[9px] text-slate-400 text-right mt-6 uppercase font-black italic tracking-widest leading-none font-bold">
                                            ‚Äî PJ: {log.addedBy || log.requester}
                                          </p>
                                        </div>
                                      </div>
                                    ))}
                                  </div>
                                )}

                                {/* PANEL PRIORITAS ADMIN */}
                                {isAdmin && (
                                  <div className="mt-12 p-8 bg-slate-50 rounded-[2.5rem] border border-slate-200 flex flex-col md:flex-row items-center justify-between text-slate-800 shadow-inner gap-6">
                                    <div className="text-center md:text-left font-sans">
                                      <h4 className="font-serif-legal font-bold text-xl text-legal-navy mb-1">
                                        Penetapan Prioritas Perkara
                                      </h4>
                                      <p className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">
                                        Sistem Kontrol Pimpinan
                                      </p>
                                    </div>
                                    <div className="flex gap-3">
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          handleUpdatePriority(c.id, "HIGH");
                                        }}
                                        className="px-6 py-3 bg-red-600 text-white text-[9px] font-black uppercase rounded-xl hover:bg-red-700 shadow-md transition-colors"
                                      >
                                        üî• Tinggi
                                      </button>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          handleUpdatePriority(c.id, "MEDIUM");
                                        }}
                                        className="px-6 py-3 bg-amber-500 text-white text-[9px] font-black uppercase rounded-xl hover:bg-amber-600 shadow-md transition-colors"
                                      >
                                        ‚ö° Menengah
                                      </button>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          handleUpdatePriority(c.id, "NORMAL");
                                        }}
                                        className="px-6 py-3 bg-slate-200 text-slate-600 text-[9px] font-black uppercase rounded-xl hover:bg-slate-300 shadow-md transition-colors"
                                      >
                                        Normal
                                      </button>
                                    </div>
                                  </div>
                                )}

                                <div className="mt-16 flex flex-col items-center gap-6 border-t pt-10 font-bold text-center">
                                  <button
                                    onClick={() => setExpandedCase(null)}
                                    className="text-[10px] font-black text-slate-300 hover:text-legal-navy uppercase tracking-[0.6em] transition-all font-sans font-bold"
                                  >
                                    √ó Tutup Dossier File
                                  </button>
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            )}

            {/* TAB: RISET DASHBOARD */}
            {activeTab === "riset" && (isResearcher || isAdmin) && (
              <div className="space-y-16 fade-in text-left font-bold">
                <div className="flex justify-center gap-6 text-slate-800 font-bold bg-slate-100/50 p-2 rounded-2xl w-fit mx-auto shadow-sm">
                  <button
                    onClick={() => setResearchSubTab("berjalan")}
                    className={`tab-btn !px-8 !py-3 ${
                      researchSubTab === "berjalan"
                        ? "tab-active shadow-md"
                        : ""
                    }`}
                  >
                    Berjalan / Feedback
                  </button>
                  <button
                    onClick={() => setResearchSubTab("selesai")}
                    className={`tab-btn !px-8 !py-3 ${
                      researchSubTab === "selesai" ? "tab-active shadow-md" : ""
                    }`}
                  >
                    Arsip Selesai
                  </button>
                  <button
                    onClick={() => setResearchSubTab("linimasa")}
                    className={`tab-btn !px-8 !py-3 ${
                      researchSubTab === "linimasa"
                        ? "tab-active shadow-md"
                        : ""
                    }`}
                  >
                    Lini Masa Akademis
                  </button>
                </div>

                {researchSubTab === "berjalan" && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-10 fade-in text-left font-bold">
                    {researchTasks
                      .filter((t) => t.status !== "Completed")
                      .map((t) => (
                        <div
                          key={t.id}
                          className="card-premium p-10 border-t-8 border-t-indigo-600 bg-white relative overflow-hidden group shadow-lg text-left font-bold"
                        >
                          <div className="flex justify-between items-start mb-6 text-left font-bold text-slate-400 font-sans font-bold">
                            <span className="text-[10px] font-black uppercase tracking-widest underline decoration-indigo-200 decoration-2 underline-offset-8 font-bold">
                              {t.caseTitle || "Independent"}
                            </span>
                            <span
                              className={`px-3 py-1 rounded-full text-[8px] font-black uppercase italic border tracking-widest font-bold font-sans ${
                                t.status === "Submitted"
                                  ? "bg-amber-50 text-amber-600 border-amber-200"
                                  : t.status === "Revision Required"
                                  ? "bg-red-50 text-red-600 border-red-200"
                                  : "bg-indigo-50 text-indigo-700 border-indigo-100"
                              }`}
                            >
                              {t.status === "Submitted"
                                ? "Menunggu Review"
                                : t.status === "Revision Required"
                                ? "Butuh Revisi"
                                : "Dikerjakan"}
                            </span>
                          </div>
                          <h3 className="font-serif-legal font-bold text-legal-navy text-2xl mb-4 leading-tight text-left font-serif-legal font-bold">
                            {t.topic}
                          </h3>

                          <div
                            className="text-[14px] text-slate-500 italic font-serif-legal line-clamp-5 leading-loose mb-10 text-left"
                            dangerouslySetInnerHTML={{ __html: t.description }}
                          ></div>

                          {t.litigationFeedback && (
                            <div className="bg-red-50 p-6 rounded-2xl border border-red-100 mb-8 shadow-sm">
                              <p className="text-[9px] font-black text-red-700 uppercase mb-2 flex items-center gap-2">
                                <Icon name="MessageSquare" size={12} /> Catatan
                                Perbaikan:
                              </p>
                              <p className="text-sm text-red-900 italic font-serif-legal">
                                {t.litigationFeedback}
                              </p>
                              {t.revisionFileUrl && (
                                <a
                                  href={t.revisionFileUrl}
                                  target="_blank"
                                  className="mt-3 inline-flex items-center gap-2 text-red-600 text-[10px] font-bold underline"
                                >
                                  <Icon name="FileText" size={12} /> Unduh
                                  Berkas Referensi Revisi
                                </a>
                              )}
                            </div>
                          )}

                          <div className="flex justify-between items-center border-t pt-8 text-left font-bold">
                            <div className="flex gap-4 font-bold">
                              {t.referenceUrl && (
                                <a
                                  href={t.referenceUrl}
                                  target="_blank"
                                  className="p-3 bg-slate-50 text-indigo-600 rounded-2xl hover:bg-indigo-100 transition-all font-bold shadow-sm font-bold"
                                  title="Download Dasar Riset"
                                >
                                  <Icon name="Download" size={20} />
                                </a>
                              )}
                              {t.resultUrl && (
                                <a
                                  href={t.resultUrl}
                                  target="_blank"
                                  className="p-3 bg-emerald-50 text-emerald-600 rounded-2xl hover:bg-emerald-100 transition-all font-bold shadow-sm font-bold"
                                  title="Unduh Hasil Kajian"
                                >
                                  <Icon name="FileText" size={20} />
                                </a>
                              )}
                              {!isAdmin && isResearcher && (
                                <button
                                  onClick={() => {
                                    setSelectedItem(t);
                                    setRtContent("");
                                    setModalType("finish-research");
                                  }}
                                  className="btn-action bg-indigo-600 !text-white !py-3 rounded-full font-black text-[9px] uppercase font-bold font-sans shadow-lg font-bold"
                                >
                                  {t.status === "Submitted"
                                    ? "Update Hasil"
                                    : "Submit Hasil ‚ûî"}
                                </button>
                              )}
                            </div>
                            <div className="flex gap-2 font-bold">
                              {!isAdmin && isResearcher && (
                                <button
                                  onClick={() => {
                                    setSelectedItem(t);
                                    setRtContent(t.description);
                                    setModalType("edit-research");
                                  }}
                                  className="p-3 text-slate-200 hover:text-legal-navy transition-colors font-bold"
                                >
                                  <Icon name="Edit" size={20} />
                                </button>
                              )}
                              {isAdmin && (
                                <button
                                  onClick={() => {
                                    if (confirm("Hapus?"))
                                      getCol("research_tasks")
                                        .doc(t.id)
                                        .delete();
                                  }}
                                  className="p-3 text-slate-200 hover:text-red-500 transition-colors font-bold"
                                >
                                  <Icon name="Trash" size={20} />
                                </button>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                  </div>
                )}
                {researchSubTab === "selesai" && (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-10 fade-in text-left font-bold">
                    {researchTasks
                      .filter((t) => t.status === "Completed")
                      .map((t) => (
                        <div
                          key={t.id}
                          className="card-premium p-10 border-t-8 border-t-green-600 bg-white relative overflow-hidden group shadow-lg text-left font-bold"
                        >
                          <span className="text-[10px] font-black uppercase tracking-widest mb-4 block underline font-bold font-sans text-slate-400 font-bold">
                            {t.caseTitle || "Mandiri"}
                          </span>
                          <h3 className="font-serif-legal font-bold text-legal-navy text-2xl mb-4 leading-tight text-left font-bold font-serif-legal font-bold">
                            {t.topic}
                          </h3>
                          <div className="bg-green-50 p-6 rounded-2xl border border-green-100 font-sans shadow-inner text-green-800 mb-6 text-left font-bold">
                            <p className="text-[9px] font-black text-green-700 uppercase mb-2 flex items-center gap-2 font-bold font-bold">
                              <Icon name="CheckCircle" size={12} /> Analisa
                              Final:
                            </p>
                            <div
                              className="text-slate-800 text-[13px] italic font-serif-legal leading-relaxed font-bold"
                              dangerouslySetInnerHTML={{
                                __html: t.analysisResult,
                              }}
                            ></div>
                          </div>
                          <div className="flex items-center gap-4">
                            {t.resultUrl && (
                              <a
                                href={t.resultUrl}
                                target="_blank"
                                className="inline-flex items-center gap-2 px-8 py-2.5 bg-green-600 text-white rounded-full text-[9px] font-black uppercase shadow-lg font-sans transition-all hover:scale-105 font-bold font-bold"
                              >
                                Unduh (PDF)
                              </a>
                            )}
                            <p className="text-[8px] text-slate-400 uppercase font-black">
                              PJ: {t.reviewer}
                            </p>
                          </div>
                        </div>
                      ))}
                  </div>
                )}
                {researchSubTab === "linimasa" && (
                  <div className="space-y-16 font-bold">
                    {Object.keys(groupedResearch).map((caseTitle) => (
                      <div
                        key={caseTitle}
                        className="bg-white p-12 rounded-[3.5rem] border border-slate-200 relative overflow-hidden text-left shadow-sm font-bold font-bold"
                      >
                        <div className="flex items-center gap-6 mb-12 pb-8 border-b border-slate-50 text-slate-800 font-bold text-left font-bold">
                          <div className="p-5 bg-royal-deep text-royal-600 rounded-3xl shadow-xl font-bold font-bold font-bold">
                            <Icon name="Layers" size={32} />
                          </div>
                          <div className="text-left font-bold">
                            <h3 className="font-serif-legal text-3xl font-bold text-legal-navy text-left font-bold font-serif-legal font-bold">
                              {caseTitle}
                            </h3>
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left font-sans font-bold">
                              Audit Teori Akademis Perkara
                            </p>
                          </div>
                        </div>
                        <div className="relative pl-12 border-l-2 border-slate-100 space-y-12 z-10 text-left font-bold">
                          {groupedResearch[caseTitle].map((t) => (
                            <div
                              key={t.id}
                              className="relative group text-left font-bold"
                            >
                              <div className="absolute -left-[54px] top-2 w-7 h-7 rounded-full bg-white border-4 border-royal-600 shadow-lg transition-transform group-hover:scale-125 font-bold font-bold"></div>
                              <div className="bg-slate-50/50 p-8 rounded-[2.5rem] hover:bg-white hover:shadow-2xl transition-all border border-transparent hover:border-royal-100 text-left text-slate-800 font-bold shadow-sm font-bold">
                                <div className="flex justify-between items-start mb-4">
                                  <span className="text-[11px] font-black text-royal-600 uppercase tracking-widest font-sans font-bold font-bold">
                                    {t.topic}
                                  </span>
                                  <div className="flex gap-2">
                                    {isLitigator && (
                                      <button
                                        onClick={() => {
                                          setSelectedItem(t);
                                          setRtContent(t.description);
                                          setModalType("edit-research");
                                        }}
                                        className="p-1.5 text-slate-300 hover:text-legal-gold transition-colors"
                                      >
                                        <Icon name="Edit" size={14} />
                                      </button>
                                    )}
                                  </div>
                                </div>
                                <div
                                  className="text-sm text-slate-500 italic font-serif-legal mb-6 leading-relaxed text-left text-slate-500 font-bold font-serif-legal font-bold"
                                  dangerouslySetInnerHTML={{
                                    __html: t.description,
                                  }}
                                ></div>
                                {t.analysisResult && (
                                  <div className="bg-green-50 p-6 rounded-2xl border border-green-100 font-sans shadow-inner text-green-800 font-sans font-bold text-left font-bold">
                                    <p className="text-[9px] font-black text-green-700 uppercase mb-2 flex items-center gap-2 font-bold font-sans font-bold font-bold font-bold">
                                      <Icon name="CheckCircle" size={12} />{" "}
                                      Analisa Akhir:
                                    </p>
                                    <div
                                      className="text-slate-800 text-sm italic font-serif-legal leading-relaxed font-bold font-bold"
                                      dangerouslySetInnerHTML={{
                                        __html: t.analysisResult,
                                      }}
                                    ></div>
                                  </div>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {/* MODALS SECTION */}
            {/* LITIGATION FEEDBACK MODAL (Review Riset) */}
            {modalType === "litigation-feedback" && selectedItem && (
              <div className="fixed inset-0 z-[10000] bg-royal-deep/60 backdrop-blur-xl flex items-center justify-center p-6 text-left shadow-2xl font-bold">
                <div className="bg-white w-full max-w-2xl p-10 rounded-[3rem] shadow-2xl fade-in overflow-y-auto max-h-[90vh] text-left border-t-[12px] border-royal-600">
                  <h2 className="font-serif-legal text-3xl font-bold text-royal-700 uppercase tracking-tight border-b pb-6 mb-8 text-left font-bold">
                    Review Kajian Riset
                  </h2>
                  <div className="mb-8 p-6 bg-slate-50 rounded-2xl border">
                    <p className="text-[10px] font-black text-slate-400 uppercase mb-2">
                      Topik:
                    </p>
                    <p className="text-lg font-bold text-legal-navy mb-4">
                      {selectedItem.topic}
                    </p>
                    <p className="text-[10px] font-black text-slate-400 uppercase mb-2">
                      Analisa Tim Riset:
                    </p>
                    <div
                      className="text-sm text-slate-700 italic font-serif-legal"
                      dangerouslySetInnerHTML={{
                        __html: selectedItem.analysisResult,
                      }}
                    ></div>
                  </div>
                  <form id="feedback-form" className="space-y-6">
                    <div>
                      <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">
                        Uraian Detail Instruksi Revisi / Masukan Litigasi
                      </label>
                      <textarea
                        name="feedback"
                        className="input-premium h-32 text-slate-800 font-bold"
                        placeholder="Ketik secara detail bagian mana yang perlu diperbaiki..."
                      ></textarea>
                    </div>
                    <div className="bg-slate-50 p-5 rounded-2xl border border-dashed">
                      <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">
                        Lampirkan Dokumen Referensi Revisi (PDF)
                      </label>
                      <input
                        type="file"
                        name="revFile"
                        accept=".pdf"
                        className="text-xs font-bold w-full bg-white p-2 rounded-lg border"
                      />
                    </div>
                    <div className="flex flex-col md:flex-row gap-4">
                      <button
                        type="button"
                        onClick={(e) => submitLitigationFeedback("REVISE")}
                        className="flex-1 px-8 py-5 border-2 border-red-500 text-red-600 rounded-2xl font-black text-[10px] uppercase hover:bg-red-50 transition tracking-widest"
                      >
                        ‚ö†Ô∏è Butuh Revisi
                      </button>
                      <button
                        type="button"
                        onClick={(e) => submitLitigationFeedback("APPROVE")}
                        className="flex-1 px-8 py-5 bg-green-600 text-white rounded-2xl font-black text-[10px] uppercase hover:bg-green-700 transition tracking-widest shadow-lg"
                      >
                        ‚úÖ Selesaikan & Arsipkan
                      </button>
                    </div>
                    <button
                      type="button"
                      onClick={() => {
                        setModalType(null);
                        setSelectedItem(null);
                        setRtContent("");
                      }}
                      className="w-full text-[10px] font-black text-slate-300 uppercase mt-4"
                    >
                      Batal
                    </button>
                  </form>
                </div>
              </div>
            )}

            {/* GENERIC MODALS */}
            {modalType === "case" && selectedItem && (
              <div className="fixed inset-0 z-[10000] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-6 text-left shadow-2xl font-bold">
                <div className="bg-white w-full max-w-3xl p-10 rounded-[3rem] shadow-2xl fade-in overflow-y-auto max-h-[90vh] text-left shadow-2xl font-bold">
                  <h2 className="font-serif-legal text-3xl font-bold text-legal-navy uppercase tracking-tight border-b pb-6 mb-10 text-left font-bold font-serif-legal font-bold">
                    Edit Dossier Perkara
                  </h2>
                  <form
                    onSubmit={handleSaveCase}
                    className="space-y-6 text-slate-800 font-bold font-sans font-bold"
                  >
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-left font-bold font-bold">
                      <div className="space-y-6">
                        <div>
                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans font-bold">
                            Jenis Tindakan
                          </label>
                          <select
                            name="at"
                            className="input-premium font-bold text-slate-800"
                            defaultValue={
                              selectedItem?.actionType || "LITIGASI"
                            }
                          >
                            <option value="LITIGASI">LITIGASI</option>
                            <option value="NON-LITIGASI">NON-LITIGASI</option>
                          </select>
                        </div>
                        <div>
                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans font-bold">
                            Klasifikasi
                          </label>
                          <select
                            name="ty"
                            className="input-premium font-bold text-slate-800 text-left font-sans font-bold"
                            defaultValue={selectedItem?.type}
                          >
                            <option>PERDATA</option>
                            <option>PIDANA</option>
                            <option>TUN</option>
                            <option>NIAGA</option>
                          </select>
                        </div>
                        <div>
                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-bold text-slate-800 text-left font-sans font-bold">
                            ID SIMER
                          </label>
                          <input
                            name="sid"
                            className="input-premium font-bold text-slate-800 text-left font-sans font-bold"
                            defaultValue={selectedItem?.simerId}
                            placeholder="SMR-XXXX"
                          />
                        </div>
                      </div>
                      <div className="space-y-6">
                        <div>
                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-bold text-slate-800 text-left font-sans font-bold">
                            Arsip No.
                          </label>
                          <input
                            name="n"
                            className="input-premium font-mono uppercase text-slate-800 font-bold text-left font-sans font-bold"
                            defaultValue={selectedItem?.number}
                            required
                          />
                        </div>
                        <div className="text-left text-slate-800 font-bold font-sans font-bold">
                          <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block text-left font-bold font-bold">
                            Klien / Subjek
                          </label>
                          <input
                            name="t"
                            className="input-premium font-bold text-slate-800 font-sans font-bold"
                            defaultValue={selectedItem?.title}
                            required
                          />
                        </div>
                      </div>
                    </div>
                    <RichEditor value={rtContent} onChange={setRtContent} />
                    <div className="flex justify-end gap-4 pt-4 text-left font-bold font-bold">
                      <button
                        type="button"
                        onClick={() => {
                          setModalType(null);
                          setSelectedItem(null);
                          setRtContent("");
                        }}
                        className="px-8 py-4 text-[10px] font-black uppercase text-slate-400 font-sans font-bold font-sans font-bold font-bold"
                      >
                        Batal
                      </button>
                      <button
                        disabled={loading}
                        className="btn-action px-16 shadow-xl uppercase font-bold text-white font-bold font-sans font-bold font-bold"
                      >
                        Simpan Perubahan
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {modalType === "finish-research" && selectedItem && (
              <div className="fixed inset-0 z-[10000] bg-indigo-900/40 backdrop-blur-xl flex items-center justify-center p-6 text-left font-bold">
                <div className="bg-white w-full max-w-2xl p-10 rounded-[3rem] shadow-2xl fade-in border-t-[12px] border-indigo-600">
                  <h2 className="font-serif-legal text-3xl font-bold text-indigo-700 uppercase border-b pb-6 mb-8 text-left font-bold font-sans font-bold font-bold">
                    Kirim Hasil Kajian
                  </h2>
                  <form
                    onSubmit={async (e) => {
                      e.preventDefault();
                      setLoading(true);
                      const fd = new FormData(e.target);
                      const file = e.target.resFinalFile.files[0];
                      try {
                        let fileUrl = selectedItem.resultUrl || "";
                        if (file) {
                          const ref = storage.ref(
                            `research_final/${selectedItem.id}/${Date.now()}_${
                              file.name
                            }`
                          );
                          await ref.put(file);
                          fileUrl = await ref.getDownloadURL();
                        }
                        await getCol("research_tasks")
                          .doc(selectedItem.id)
                          .update({
                            status: "Submitted",
                            analysisResult: rtContent,
                            resultUrl: fileUrl,
                            completedBy: userData.name,
                            submittedAt:
                              firebase.firestore.FieldValue.serverTimestamp(),
                          });
                        setModalType(null);
                        setRtContent("");
                        setSelectedItem(null);
                        alert("Berhasil Dikirim.");
                      } catch (e) {
                        alert(e.message);
                      } finally {
                        setLoading(false);
                      }
                    }}
                    className="space-y-6 font-sans font-bold"
                  >
                    <div>
                      <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">
                        Ringkasan Analisa Hukum (Uraian)
                      </label>
                      <RichEditor
                        value={rtContent}
                        onChange={setRtContent}
                        height="200px"
                      />
                    </div>
                    <div className="p-8 border-2 border-dashed border-indigo-100 rounded-3xl bg-slate-50 text-center text-slate-400 font-bold font-sans shadow-inner">
                      <input
                        type="file"
                        name="resFinalFile"
                        accept=".pdf"
                        className="text-xs font-bold"
                      />
                      <p className="text-[9px] font-bold text-slate-400 uppercase mt-2 font-sans font-bold">
                        Laporan Akhir (PDF)
                      </p>
                    </div>
                    <div className="flex justify-end gap-6 pt-6 text-white font-bold font-sans">
                      <button
                        type="button"
                        onClick={() => {
                          setModalType(null);
                          setSelectedItem(null);
                          setRtContent("");
                        }}
                        className="px-10 py-4 text-[11px] font-black uppercase text-slate-400 font-sans font-bold"
                      >
                        Batal
                      </button>
                      <button
                        disabled={loading}
                        className="btn-action bg-indigo-600 text-white font-bold uppercase tracking-widest shadow-xl"
                      >
                        Kirim Ke Litigasi ‚ûî
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {modalType === "edit-research" && selectedItem && (
              <div className="fixed inset-0 z-[10000] bg-indigo-900/80 backdrop-blur-md flex items-center justify-center p-6 shadow-2xl">
                <div className="bg-white w-full max-w-2xl p-10 rounded-[3rem] shadow-2xl fade-in border-t-[12px] border-indigo-600">
                  <h2 className="font-serif-legal text-3xl font-bold text-indigo-700 uppercase border-b pb-6 mb-10">
                    Uraian Instruksi Kajian Riset
                  </h2>
                  <form
                    onSubmit={handleUpdateResearchTask}
                    className="space-y-6"
                  >
                    <div className="text-left font-bold text-slate-800 font-sans">
                      <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                        Topik / Masalah Hukum
                      </label>
                      <input
                        name="tp"
                        defaultValue={selectedItem.topic}
                        className="input-premium font-bold text-slate-800"
                        required
                      />
                    </div>
                    <div className="text-left font-bold text-slate-800 font-sans">
                      <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">
                        Detail Permasalahan Riset
                      </label>
                      <RichEditor value={rtContent} onChange={setRtContent} />
                    </div>
                    <div className="flex justify-end gap-4 pt-4">
                      <button
                        type="button"
                        onClick={() => {
                          setModalType(null);
                          setSelectedItem(null);
                          setRtContent("");
                        }}
                        className="px-8 py-4 text-[10px] font-black uppercase text-slate-400"
                      >
                        Batal
                      </button>
                      <button
                        disabled={loading}
                        className="btn-action px-16 bg-indigo-600 text-white"
                      >
                        Perbarui Instruksi
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {modalType === "edit-log" && selectedItem && (
              <div className="fixed inset-0 z-[10000] bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-6 text-left shadow-2xl font-bold">
                <div className="bg-white w-full max-w-2xl p-10 rounded-[3rem] shadow-2xl fade-in overflow-y-auto max-h-[90vh] text-left shadow-2xl font-bold">
                  <h2 className="font-serif-legal text-3xl font-bold text-legal-navy uppercase tracking-tight border-b pb-6 mb-10 text-left font-bold font-serif-legal font-bold">
                    Edit Aktivitas Perkara
                  </h2>
                  <form onSubmit={handleAddProgress} className="space-y-6">
                    <div className="grid grid-cols-2 gap-6 text-left font-bold text-slate-800">
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          Tanggal Agenda
                        </label>
                        <input
                          type="date"
                          name="date"
                          defaultValue={selectedItem.date}
                          className="input-premium font-bold text-slate-800"
                          required
                        />
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          Waktu Laporan
                        </label>
                        <input
                          type="time"
                          name="time"
                          defaultValue={selectedItem.time}
                          className="input-premium font-bold text-slate-800"
                          required
                        />
                      </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-left font-bold text-slate-800">
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          Kategori
                        </label>
                        <select
                          name="cat"
                          defaultValue={selectedItem.category}
                          className="input-premium font-bold text-slate-800"
                        >
                          <option value="SIDANG">PERSIDANGAN</option>
                          <option value="LAPANGAN">INVESTIGASI/LAPANGAN</option>
                          <option value="ADMIN">ADMINISTRASI KANTOR</option>
                          <option value="KOORDINASI">
                            KOORDINASI INTERNAL/KLIEN
                          </option>
                        </select>
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          Lokasi
                        </label>
                        <input
                          name="loc"
                          defaultValue={selectedItem.location}
                          className="input-premium font-bold text-slate-800"
                          required
                        />
                      </div>
                    </div>
                    <div className="text-left font-bold text-slate-800 font-sans">
                      <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                        Header Aktivitas
                      </label>
                      <input
                        name="act"
                        defaultValue={selectedItem.activity}
                        className="input-premium font-bold text-slate-800"
                        required
                      />
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-left font-bold text-slate-800">
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          Kendala
                        </label>
                        <textarea
                          name="kendala"
                          defaultValue={selectedItem.kendala}
                          className="input-premium h-20 font-bold"
                        ></textarea>
                      </div>
                      <div>
                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block font-sans">
                          Rencana
                        </label>
                        <textarea
                          name="rencana"
                          defaultValue={selectedItem.rencana}
                          className="input-premium h-20 font-bold"
                        ></textarea>
                      </div>
                    </div>
                    <div className="bg-slate-50 p-6 rounded-2xl border border-dashed border-slate-200">
                      <label className="text-[10px] font-bold text-slate-400 uppercase mb-3 block font-sans flex items-center gap-2">
                        <Icon name="Camera" size={14} /> Perbarui Foto
                        Dokumentasi
                      </label>
                      <input
                        type="file"
                        name="photo"
                        accept="image/*"
                        className="text-xs font-bold text-slate-500 bg-white p-3 rounded-xl border w-full"
                      />
                    </div>
                    <RichEditor value={rtContent} onChange={setRtContent} />
                    <div className="flex justify-end gap-4 pt-4 text-left font-bold font-bold">
                      <button
                        type="button"
                        onClick={() => {
                          setModalType(null);
                          setSelectedItem(null);
                          setRtContent("");
                        }}
                        className="px-8 py-4 text-[10px] font-black uppercase text-slate-400"
                      >
                        Batal
                      </button>
                      <button
                        disabled={loading}
                        className="btn-action px-16 shadow-xl uppercase font-bold text-white"
                      >
                        Simpan Perubahan
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            )}
          </div>
        );
      }

      function App() {
        const [user, setUser] = useState(null);
        const [userData, setUserData] = useState(null);
        const [init, setInit] = useState(false);

        useEffect(() => {
          return auth.onAuthStateChanged(async (u) => {
            if (u) {
              const snap = await db
                .collection("artifacts")
                .doc(appId)
                .collection("public")
                .doc("data")
                .collection("users")
                .doc(u.uid)
                .get();
              setUserData(
                snap.exists
                  ? snap.data()
                  : { name: u.email?.split("@")[0], role: "litigasi" }
              );
              setUser(u);
            } else {
              setUser(null);
              setUserData(null);
            }
            setInit(true);
          });
        }, []);

        if (!init)
          return (
            <div className="h-screen flex flex-col items-center justify-center bg-legal-navy text-legal-gold font-bold text-center">
              <div className="w-16 h-16 border-4 border-t-white border-slate-700 rounded-full animate-spin mb-6"></div>
              <p className="text-[11px] font-bold uppercase tracking-[0.5em] animate-pulse font-sans font-bold">
                ACCESSING MATRIX...
              </p>
            </div>
          );

        if (!user) return <AuthPage />;

        return (
          <div className="min-h-screen">
            <header className="fixed top-0 left-0 right-0 z-[100] py-5 px-10 header-glass flex justify-between items-center text-slate-800 shadow-sm border-b font-sans font-bold font-bold">
              <div className="flex items-center gap-6">
                <div className="w-14 h-14 bg-legal-navy rounded-2xl flex items-center justify-center text-legal-gold shadow-2xl border-2 border-white rotate-3 hover:rotate-0 transition-transform font-bold">
                  <Icon name="Shield" size={30} />
                </div>
                <div className="text-left">
                  <h1 className="font-serif-legal font-bold text-2xl text-legal-navy leading-none mb-1 font-bold uppercase tracking-tight">
                    SIKOTIM
                  </h1>
                  <p className="text-[8px] font-bold text-slate-400 uppercase tracking-[0.4em] italic font-sans font-bold">
                    SUI IURIS LAW OFFICE
                  </p>
                </div>
              </div>
              <div className="flex items-center gap-10 text-slate-800 font-bold font-bold">
                <div className="text-right hidden sm:block">
                  <p className="text-[13px] font-black uppercase text-legal-navy tracking-tight leading-none mb-1 font-sans font-bold">
                    {userData?.name}
                  </p>
                  <p className="text-[9px] font-bold text-legal-gold uppercase tracking-widest italic border-r-2 border-legal-gold/30 pr-4 leading-none font-bold uppercase font-sans font-bold font-bold">
                    Team: {userData?.role}
                  </p>
                </div>
                <button
                  onClick={() => auth.signOut()}
                  className="p-3.5 bg-slate-50 text-slate-400 border border-slate-200 rounded-2xl hover:bg-red-50 hover:text-red-600 transition-all active:scale-90 shadow-md font-bold font-bold font-bold font-bold"
                >
                  <Icon name="Logout" size={22} />
                </button>
              </div>
            </header>
            <main>
              <MainDashboard user={user} userData={userData} />
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
